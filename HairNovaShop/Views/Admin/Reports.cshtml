@{
    ViewData["Title"] = "Thống kê báo cáo";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page-header">
    <h1>Thống kê báo cáo</h1>
    <p>Báo cáo tổng quan về doanh thu, đơn hàng và khách hàng</p>
</div>

<!-- Date Filter -->
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <h2 class="admin-card-title">Lọc theo khoảng thời gian</h2>
    </div>
    <div class="admin-card-body">
        <form method="get" asp-controller="Admin" asp-action="Reports" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="fromDate" class="form-label">Từ ngày</label>
                <input type="date" class="form-control" id="fromDate" name="fromDate" value="@ViewBag.FromDate" />
            </div>
            <div class="col-md-4">
                <label for="toDate" class="form-label">Đến ngày</label>
                <input type="date" class="form-control" id="toDate" name="toDate" value="@ViewBag.ToDate" />
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter me-1"></i> Lọc
                </button>
                <a asp-controller="Admin" asp-action="Reports" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i> Xóa bộ lọc
                </a>
            </div>
        </form>
        @if (ViewBag.FilterActive == true)
        {
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Đang hiển thị dữ liệu từ <strong>@ViewBag.FromDateDisplay</strong> đến <strong>@ViewBag.ToDateDisplay</strong>
            </div>
        }
    </div>
</div>

<!-- Revenue Statistics Cards -->
<div class="admin-stats-grid mb-4">
    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Tổng doanh thu</p>
                <h3 class="admin-stat-card-value">@(((decimal)ViewBag.TotalRevenue).ToString("N0")) đ</h3>
            </div>
            <div class="admin-stat-card-icon primary">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
        <p class="admin-stat-card-footer">Tất cả đơn hàng đã hoàn thành</p>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Doanh thu hôm nay</p>
                <h3 class="admin-stat-card-value">@(((decimal)ViewBag.TodayRevenue).ToString("N0")) đ</h3>
            </div>
            <div class="admin-stat-card-icon success">
                <i class="fas fa-calendar-day"></i>
            </div>
        </div>
        <p class="admin-stat-card-footer">Đơn hàng hoàn thành hôm nay</p>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Doanh thu tháng này</p>
                <h3 class="admin-stat-card-value">@(((decimal)ViewBag.ThisMonthRevenue).ToString("N0")) đ</h3>
            </div>
            <div class="admin-stat-card-icon info">
                <i class="fas fa-calendar-alt"></i>
            </div>
        </div>
        <p class="admin-stat-card-footer">
            @{
                var revenueGrowth = ViewBag.LastMonthRevenue > 0 
                    ? Math.Round(((decimal)ViewBag.ThisMonthRevenue - (decimal)ViewBag.LastMonthRevenue) / (decimal)ViewBag.LastMonthRevenue * 100, 1)
                    : 0;
                var revenueGrowthClass = revenueGrowth >= 0 ? "text-success" : "text-danger";
                var revenueGrowthIcon = revenueGrowth >= 0 ? "fa-arrow-up" : "fa-arrow-down";
            }
            <span class="@revenueGrowthClass">
                <i class="fas @revenueGrowthIcon"></i> @Math.Abs(revenueGrowth)%
            </span>
            so với tháng trước
        </p>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Tổng số đơn hàng</p>
                <h3 class="admin-stat-card-value">@ViewBag.TotalOrders</h3>
            </div>
            <div class="admin-stat-card-icon warning">
                <i class="fas fa-shopping-cart"></i>
            </div>
        </div>
        <p class="admin-stat-card-footer">@ViewBag.TodayOrders đơn hôm nay, @ViewBag.ThisMonthOrders đơn tháng này</p>
    </div>
</div>

<!-- Revenue Chart -->
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            @if (ViewBag.FilterActive == true)
            {
                <text>Doanh thu theo khoảng thời gian đã chọn</text>
            }
            else
            {
                <text>Doanh thu theo tháng (12 tháng gần nhất)</text>
            }
        </h2>
    </div>
    <div class="admin-card-body">
        <canvas id="revenueChart" height="80"></canvas>
    </div>
</div>

<!-- Order Statistics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">Đơn hàng theo trạng thái</h2>
            </div>
            <div class="admin-card-body">
                <canvas id="ordersByStatusChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">Đơn hàng trong 30 ngày gần nhất</h2>
            </div>
            <div class="admin-card-body">
                <canvas id="dailyOrdersChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Order Statistics Cards -->
<div class="admin-stats-grid mb-4">
    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Đơn hoàn thành</p>
                <h3 class="admin-stat-card-value text-success">@ViewBag.CompletedOrders</h3>
            </div>
            <div class="admin-stat-card-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Đang giao hàng</p>
                <h3 class="admin-stat-card-value text-primary">@ViewBag.ShippingOrders</h3>
            </div>
            <div class="admin-stat-card-icon info">
                <i class="fas fa-shipping-fast"></i>
            </div>
        </div>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Đã xác nhận</p>
                <h3 class="admin-stat-card-value" style="color: #0dcaf0;">@ViewBag.ConfirmedOrders</h3>
            </div>
            <div class="admin-stat-card-icon" style="background: linear-gradient(135deg, #0dcaf0, #0aa2c0);">
                <i class="fas fa-check-double"></i>
            </div>
        </div>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Chờ xác nhận</p>
                <h3 class="admin-stat-card-value text-warning">@ViewBag.PendingOrders</h3>
            </div>
            <div class="admin-stat-card-icon warning">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>

    <div class="admin-stat-card">
        <div class="admin-stat-card-header">
            <div>
                <p class="admin-stat-card-title">Đã hủy</p>
                <h3 class="admin-stat-card-value text-danger">@ViewBag.CancelledOrders</h3>
            </div>
            <div class="admin-stat-card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-times-circle"></i>
            </div>
        </div>
    </div>
</div>

<!-- Customer Statistics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    @if (ViewBag.FilterActive == true)
                    {
                        <text>Khách hàng đăng ký theo khoảng thời gian đã chọn</text>
                    }
                    else
                    {
                        <text>Khách hàng đăng ký theo tháng (12 tháng gần nhất)</text>
                    }
                </h2>
            </div>
            <div class="admin-card-body">
                <canvas id="customersChart" height="80"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <div class="admin-stat-card-header">
                    <div>
                        <p class="admin-stat-card-title">Tổng khách hàng</p>
                        <h3 class="admin-stat-card-value">@ViewBag.TotalCustomers</h3>
                    </div>
                    <div class="admin-stat-card-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-card-header">
                    <div>
                        <p class="admin-stat-card-title">Khách hàng mới tháng này</p>
                        <h3 class="admin-stat-card-value">@ViewBag.NewCustomersThisMonth</h3>
                    </div>
                    <div class="admin-stat-card-icon success">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
                <p class="admin-stat-card-footer">
                    @{
                        var customerGrowth = ViewBag.NewCustomersLastMonth > 0 
                            ? Math.Round(((int)ViewBag.NewCustomersThisMonth - (int)ViewBag.NewCustomersLastMonth) / (double)ViewBag.NewCustomersLastMonth * 100, 1)
                            : (ViewBag.NewCustomersThisMonth > 0 ? 100 : 0);
                        var customerGrowthClass = customerGrowth >= 0 ? "text-success" : "text-danger";
                        var customerGrowthIcon = customerGrowth >= 0 ? "fa-arrow-up" : "fa-arrow-down";
                    }
                    <span class="@customerGrowthClass">
                        <i class="fas @customerGrowthIcon"></i> @Math.Abs(customerGrowth)%
                    </span>
                    so với tháng trước (@ViewBag.NewCustomersLastMonth khách hàng)
                </p>
            </div>

            
        </div>
    </div>
</div>

<!-- Top Products -->
<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">Top 10 sản phẩm bán chạy nhất (theo doanh thu)</h2>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên sản phẩm</th>
                    <th>Số lượng bán</th>
                    <th>Doanh thu</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var topProducts = ViewBag.TopProducts as List<Dictionary<string, object>>;
                    int index = 1;
                }
                @if (topProducts != null && topProducts.Count > 0)
                {
                    @foreach (var product in topProducts)
                    {
                        <tr>
                            <td>@index</td>
                            <td><strong>@product["ProductName"]</strong></td>
                            <td>@product["Quantity"]</td>
                            <td><strong class="text-success">@(((decimal)product["Revenue"]).ToString("N0")) đ</strong></td>
                        </tr>
                        index++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted">Chưa có dữ liệu</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart');
        const revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.MonthlyLabels)),
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: @Html.Raw(Json.Serialize(ViewBag.MonthlyRevenue)),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' đ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN').format(value) + ' đ';
                            }
                        }
                    }
                }
            }
        });

        // Orders by Status Chart
        const ordersByStatusCtx = document.getElementById('ordersByStatusChart');
        const ordersByStatusData = @Html.Raw(Json.Serialize(ViewBag.OrdersByStatus));
        const ordersByStatusChart = new Chart(ordersByStatusCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(ordersByStatusData),
                datasets: [{
                    data: Object.values(ordersByStatusData),
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',    // Hoàn thành - green
                        'rgba(59, 130, 246, 0.8)',   // Đang giao hàng - blue
                        'rgba(13, 202, 240, 0.8)',   // Đã xác nhận - cyan
                        'rgba(251, 191, 36, 0.8)',   // Chờ xác nhận - yellow
                        'rgba(239, 68, 68, 0.8)'     // Đã hủy - red
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',
                        'rgb(59, 130, 246)',
                        'rgb(13, 202, 240)',
                        'rgb(251, 191, 36)',
                        'rgb(239, 68, 68)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Daily Orders Chart
        const dailyOrdersCtx = document.getElementById('dailyOrdersChart');
        const dailyOrdersChart = new Chart(dailyOrdersCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.DailyLabels)),
                datasets: [{
                    label: 'Số đơn hàng',
                    data: @Html.Raw(Json.Serialize(ViewBag.DailyOrders)),
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Customers Chart
        const customersCtx = document.getElementById('customersChart');
        const customersChart = new Chart(customersCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(ViewBag.MonthlyCustomerLabels)),
                datasets: [{
                    label: 'Số khách hàng mới',
                    data: @Html.Raw(Json.Serialize(ViewBag.MonthlyCustomers)),
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    </script>
}
